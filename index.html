<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CIPHER_NEXUS | BLACK BOX</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@100..800&display=swap');
        :root { --p: #0f0; --b: #000; --d: #050505; --e: #ff3333; }
        body { background: var(--d); color: var(--p); font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .scanline { width: 100%; height: 100px; z-index: 50; background: linear-gradient(0deg, transparent 0%, rgba(0, 255, 0, 0.04) 50%, transparent 100%); opacity: 0.1; position: absolute; bottom: 100%; animation: scan 10s linear infinite; pointer-events: none; }
        @keyframes scan { 0% { bottom: 100%; } 100% { bottom: -100%; } }
        .term-border { border: 1px solid #00ff41; box-shadow: 0 0 10px rgba(0, 255, 65, 0.2); background: rgba(0,0,0,0.95); }
        .loading-bar { width: 0%; height: 2px; background: #0f0; transition: width 0.2s; }
        #boot-log { font-size: 10px; color: #005500; margin-top: 10px; height: 100px; overflow: hidden; }
    </style>
</head>
<body>
    <div id="root">
        <div style="height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column;background:#000;color:#0f0;">
            <div style="font-size:24px;letter-spacing:5px;margin-bottom:20px;">SYSTEM BOOT</div>
            <div style="width:300px;background:#002200;height:4px;"><div id="loader" class="loading-bar"></div></div>
            <div id="boot-log">Initialize...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const log = (msg) => {
            const el = document.getElementById('boot-log');
            if(el) el.innerHTML += `<div>> ${msg}</div>`;
            console.log(`[SYS] ${msg}`);
        };

        // HEX DECODER (Obfuscates your keys in the source code)
        const hex = (str) => str.match(/.{1,2}/g).map(byte => String.fromCharCode(parseInt(byte, 16))).join('');

        // ENCRYPTED CONFIG BLOB
        // This is your config, converted to Hex so it's not plain text
        const _0x1a2b = {
            apiKey: "41497a615379425159596e4a5934304651577a6d6c524c6e725162456e4f5049503347506e2d6b",
            authDomain: "756e6373616d2d64393338642e66697265626173656170702e636f6d",
            projectId: "756e6373616d2d6439333864",
            storageBucket: "756e6373616d2d64393338642e666972656261736573746f726167652e617070",
            messagingSenderId: "3136373939323933373634",
            appId: "313a31363739393239333736343a7765623a38333537333364643934343836383930386537373131",
            measurementId: "472d5142483039544238594b"
        };

        const getConf = () => {
            let c = {};
            for(let k in _0x1a2b) c[k] = hex(_0x1a2b[k]);
            return c;
        };

        try {
            log("Decrypting Config...");
            const app = initializeApp(getConf());
            log("Core Modules Loaded.");
            
            // Expose to window for React
            window.SYS = {
                auth: getAuth(app),
                db: getFirestore(app),
                ops: { signInAnonymously, doc, setDoc, deleteDoc, updateDoc, onSnapshot, serverTimestamp }
            };
            
            document.getElementById('loader').style.width = "50%";
            log("Waiting for Interface...");
            window.FIREBASE_READY = true; // Signal for React
        } catch (e) {
            log("CRITICAL ERROR: " + e.message);
            document.body.style.color = "red";
        }
    </script>

    <script type="text/babel" data-presets="env,react">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icon = ({ d, c }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={c}><path d={d}/></svg>;

        // --- CRYPTO ENGINE ---
        const Crypto = {
            getKey: async (p) => window.crypto.subtle.deriveKey({ name: "PBKDF2", salt: new TextEncoder().encode("BLK_BOX_SALT"), iterations: 100000, hash: "SHA-256" }, await window.crypto.subtle.importKey("raw", new TextEncoder().encode(p), { name: "PBKDF2" }, false, ["deriveKey"]), { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]),
            encrypt: async (d, k) => { const iv = window.crypto.getRandomValues(new Uint8Array(12)); const e = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv }, k, new TextEncoder().encode(JSON.stringify(d))); return btoa(String.fromCharCode(...new Uint8Array(iv), ...new Uint8Array(e))); },
            decrypt: async (b, k) => { try { const s = atob(b), c = new Uint8Array(s.length); for(let i=0;i<s.length;i++) c[i]=s.charCodeAt(i); return JSON.parse(new TextDecoder().decode(await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: c.slice(0,12) }, k, c.slice(12)))); } catch { return null; } },
            hash: async (p) => Array.from(new Uint8Array(await window.crypto.subtle.digest('SHA-256', new TextEncoder().encode(p)))).map(b=>b.toString(16).padStart(2,'0')).join('')
        };

        // --- MAIN APP ---
        const App = () => {
            const [ready, setReady] = useState(false);
            const [view, setView] = useState('boot');
            const [pass, setPass] = useState('');
            const [err, setErr] = useState('');
            const [data, setData] = useState({ key: null, id: null, widgets: [] });
            const [uid, setUid] = useState('...');

            // Bootloader: Wait for Firebase Module
            useEffect(() => {
                const interval = setInterval(() => {
                    if (window.FIREBASE_READY) {
                        clearInterval(interval);
                        setReady(true);
                    }
                }, 100);
            }, []);

            useEffect(() => { if (ready) setTimeout(() => setView('login'), 1500); }, [ready]);

            const connect = async (e) => {
                e.preventDefault();
                if (pass === '1715') { setView('duress'); return; }
                if (pass.length < 6) return setErr('WEAK KEY');
                
                setErr('HANDSHAKE...');
                try {
                    const { auth, db, ops } = window.SYS;
                    const u = await ops.signInAnonymously(auth);
                    setUid(u.user.uid.slice(0,4).toUpperCase());

                    const k = await Crypto.getKey(pass);
                    const id = await Crypto.hash(pass);
                    
                    const ref = ops.doc(db, 'secure_nodes', id);
                    ops.onSnapshot(ref, async (s) => {
                        if(s.exists() && s.data().enc) {
                            const dec = await Crypto.decrypt(s.data().enc, k);
                            if(dec) setData(prev => ({ ...prev, widgets: dec, key: k, id: id }));
                        } else if(!s.exists()) {
                            sync([], k, id);
                            setData(prev => ({ ...prev, key: k, id: id }));
                        }
                    }, (error) => {
                        console.error(error);
                        setErr('DB LOCKED. ENABLE RULES IN CONSOLE.');
                    });

                    setView('dash');
                } catch (er) {
                    console.error(er);
                    setErr('CONNECTION FAILED');
                }
            };

            const sync = async (w, k, id) => {
                if(!k || !id) return;
                const enc = await Crypto.encrypt(w, k);
                const { db, ops } = window.SYS;
                try { await ops.setDoc(ops.doc(db, 'secure_nodes', id), { enc, up: ops.serverTimestamp() }); } catch(e){}
            };

            // Actions
            const add = (t) => {
                const w = { id: Date.now().toString(), type: t, x: Math.random()*200+20, y: Math.random()*200+50, w: 300, h: 240, z: 10, d: '' };
                const nw = [...data.widgets, w];
                setData(p => ({...p, widgets: nw}));
                sync(nw, data.key, data.id);
            };
            
            const mod = (id, fields) => {
                const nw = data.widgets.map(w => w.id === id ? { ...w, ...fields } : w);
                setData(p => ({...p, widgets: nw}));
            };

            const del = (id) => {
                const nw = data.widgets.filter(w => w.id !== id);
                setData(p => ({...p, widgets: nw}));
                sync(nw, data.key, data.id);
            };

            const save = () => sync(data.widgets, data.key, data.id);

            // RENDERERS
            if (!ready) return null; // Let HTML loader show
            if (view === 'boot') return <div className="h-screen bg-black text-green-500 flex flex-col items-center justify-center"><div className="text-2xl tracking-[0.5em] mb-4">NEXUS</div><div className="text-xs animate-pulse">ESTABLISHING SECURE CONNECTION...</div></div>;
            if (view === 'duress') return <div className="h-screen bg-gray-100 p-10 font-sans text-gray-800"><h1 className="text-2xl font-bold mb-4">Apache Server Status</h1><div className="bg-white p-4 border shadow">All systems operational. Uptime: 42 days.</div></div>;
            
            if (view === 'login') return (
                <div className="h-screen bg-black text-green-500 flex items-center justify-center relative overflow-hidden">
                    <div className="scanline"></div>
                    <div className="term-border p-8 w-full max-w-sm bg-black/90 relative z-10">
                        <div className="text-center mb-8"><h1 className="text-3xl tracking-widest font-bold glow-text">BLACK BOX</h1><div className="text-[10px] mt-2 text-green-700">ZERO-KNOWLEDGE ARCHITECTURE</div></div>
                        <form onSubmit={connect}>
                            <input autoFocus type="password" value={pass} onChange={e=>setPass(e.target.value)} placeholder="ACCESS KEY" className="w-full bg-black border-b border-green-800 p-2 text-center text-green-400 focus:outline-none focus:border-green-400 tracking-[5px] mb-6 placeholder-green-900" />
                            <button className="w-full border border-green-600 py-2 hover:bg-green-900/50 transition-all text-xs font-bold tracking-widest">DECRYPT & MOUNT</button>
                        </form>
                        <div className="text-center mt-4 text-xs text-red-500 h-4">{err}</div>
                    </div>
                </div>
            );

            return (
                <div className="h-screen bg-black text-green-500 relative overflow-hidden crt" onMouseUp={save} onTouchEnd={save}>
                    <div className="scanline"></div>
                    
                    {/* Header */}
                    <div className="absolute top-0 w-full h-10 border-b border-green-900 bg-black/90 flex items-center justify-between px-4 z-50">
                        <div className="text-xs flex gap-2 items-center"><span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> ID: {uid} | NET: {data.id?.substring(0,6)}...</div>
                        <button onClick={()=>window.location.reload()} className="text-[10px] border border-red-900 text-red-500 px-2 py-1 hover:bg-red-900/20">KILL SWITCH</button>
                    </div>

                    {/* Toolbar */}
                    <div className="absolute left-0 top-10 bottom-0 w-12 border-r border-green-900 bg-black/90 z-40 flex flex-col items-center py-4 gap-4">
                        <Btn icon="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" fn={()=>add('chat')} />
                        <Btn icon="M23 7l-7 5 7 5V7z M14 5H2v14h12V5z" fn={()=>add('cam')} />
                        <Btn icon="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" fn={()=>add('vox')} />
                        <Btn icon="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z" fn={()=>add('note')} />
                    </div>

                    {/* Desktop */}
                    <div className="absolute inset-0 top-10 left-12">
                        {data.widgets.map(w => <Widget key={w.id} w={w} mod={mod} del={del} save={save} uid={uid} />)}
                    </div>
                </div>
            );
        };

        const Btn = ({ icon, fn }) => <button onClick={fn} className="p-2 text-green-600 hover:text-green-300 hover:bg-green-900/30 rounded"><Icon d={icon} c="w-5 h-5"/></button>;

        const Widget = ({ w, mod, del, save, uid }) => {
            const [drag, setDrag] = useState(false);
            const off = useRef({x:0,y:0});
            const [txt, setTxt] = useState('');
            
            // Cam Logic
            const vid = useRef(null);
            const [stream, setStream] = useState(false);
            
            const startDrag = (e) => {
                if(['INPUT','BUTTON','TEXTAREA'].includes(e.target.tagName)) return;
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                setDrag(true);
                off.current = { x: clientX - w.x, y: clientY - w.y };
            };

            useEffect(() => {
                const move = (e) => {
                    if(!drag) return;
                    const clientX = e.clientX || e.touches[0].clientX;
                    const clientY = e.clientY || e.touches[0].clientY;
                    mod(w.id, { x: clientX - off.current.x, y: clientY - off.current.y });
                };
                const up = () => { if(drag) { setDrag(false); save(); } };
                if(drag) {
                    window.addEventListener('mousemove', move); window.addEventListener('mouseup', up);
                    window.addEventListener('touchmove', move); window.addEventListener('touchend', up);
                }
                return () => { 
                    window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up);
                    window.removeEventListener('touchmove', move); window.removeEventListener('touchend', up);
                };
            }, [drag]);

            // Cam Effect
            useEffect(() => {
                let i;
                if(stream && vid.current) {
                    i = setInterval(() => {
                        const cvs = document.createElement('canvas');
                        cvs.width=160; cvs.height=120;
                        cvs.getContext('2d').drawImage(vid.current,0,0,160,120);
                        mod(w.id, { d: cvs.toDataURL('image/jpeg', 0.3) });
                        // Randomly save to sync
                        if(Math.random()>0.7) save();
                    }, 500);
                }
                return () => clearInterval(i);
            }, [stream]);

            const toggleCam = async () => {
                if(stream) { setStream(false); mod(w.id, { d: null }); save(); }
                else {
                    try {
                        const s = await navigator.mediaDevices.getUserMedia({video:{width:160,height:120}});
                        vid.current.srcObject = s;
                        setStream(true);
                    } catch { alert('CAM BLOCKED'); }
                }
            };

            const sendChat = (e) => {
                e.preventDefault();
                if(!txt) return;
                const msg = { u: uid, t: txt, tm: new Date().toLocaleTimeString() };
                mod(w.id, { d: [...(Array.isArray(w.d)?w.d:[]), msg] });
                setTxt(''); save();
            };

            return (
                <div className="absolute term-border flex flex-col bg-black/95" style={{left:w.x, top:w.y, width:w.w, height:w.h, zIndex:drag?50:w.z}} onMouseDown={startDrag} onTouchStart={startDrag}>
                    <div className="bg-green-900/20 border-b border-green-800 p-1 px-2 flex justify-between items-center cursor-move select-none">
                        <span className="text-[10px] font-bold tracking-widest uppercase">{w.type}_{w.id.slice(-3)}</span>
                        <button onClick={()=>del(w.id)} className="text-green-700 hover:text-red-500 font-bold px-2">Ã—</button>
                    </div>
                    
                    <div className="flex-1 overflow-hidden relative">
                        {w.type==='note' && <textarea className="w-full h-full bg-transparent text-green-400 p-2 text-xs font-mono resize-none focus:outline-none" value={w.d} onChange={e=>mod(w.id,{d:e.target.value})} onBlur={save} placeholder="DATA ENTRY..." />}
                        
                        {w.type==='chat' && (
                            <div className="flex flex-col h-full">
                                <div className="flex-1 overflow-y-auto p-2 space-y-1">
                                    {(Array.isArray(w.d)?w.d:[]).map((m,i)=>(<div key={i} className="text-[10px]"><span className="text-green-700">[{m.tm}]</span> <span className="font-bold">{m.u}:</span> {m.t}</div>))}
                                </div>
                                <form onSubmit={sendChat} className="border-t border-green-800 flex"><input className="flex-1 bg-black text-green-400 p-2 text-xs outline-none" value={txt} onChange={e=>setTxt(e.target.value)} /><button className="px-2 bg-green-900/20 text-xs">></button></form>
                            </div>
                        )}

                        {w.type==='cam' && (
                            <div className="h-full flex flex-col">
                                {stream && <video ref={vid} autoPlay playsInline muted className="hidden" />}
                                {stream || w.d ? <img src={w.d} className="w-full h-full object-cover opacity-80" /> : <div className="flex-1 flex items-center justify-center text-xs text-red-500">OFFLINE</div>}
                                <button onClick={toggleCam} className="bg-red-900/30 text-red-400 text-xs py-1 hover:bg-red-900/50">{stream ? 'CUT FEED' : 'INIT CAMERA'}</button>
                            </div>
                        )}

                        {w.type==='vox' && (
                            <div className="h-full flex items-center justify-center p-4">
                                <div className="w-full text-center">
                                    <div className="mb-2 text-xs text-blue-400">{w.d ? 'AUDIO PACKET RECEIVED' : 'CHANNEL IDLE'}</div>
                                    {w.d && <audio src={w.d} controls className="w-full h-6" />}
                                    <button onClick={async ()=>{
                                        try {
                                            const s = await navigator.mediaDevices.getUserMedia({audio:true});
                                            const r = new MediaRecorder(s);
                                            const c = [];
                                            r.ondataavailable=e=>c.push(e.data);
                                            r.onstop=()=>{
                                                const b = new Blob(c,{type:'audio/webm'});
                                                const rd = new FileReader();
                                                rd.readAsDataURL(b);
                                                rd.onloadend=()=>{ mod(w.id,{d:rd.result}); save(); }
                                            };
                                            r.start(); setTimeout(()=>r.stop(),5000);
                                        } catch { alert('MIC ERR'); }
                                    }} className="mt-2 border border-blue-500 text-blue-500 px-3 py-1 rounded-full text-xs hover:bg-blue-900/30">REC 5s PACKET</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>