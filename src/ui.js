import * as crypto from './crypto.js'; import * as storage from './storage.js'; import * as webrtc from './webrtc.js'; import { THEMES, applyTheme } from './themes.js'; export async function initUI(runtime){ const localId = runtime.localId; const roomInput = document.getElementById('roomInput'); const pepperInput = document.getElementById('pepperInput'); const nameInput = document.getElementById('nameInput'); const joinBtn = document.getElementById('joinBtn'); const demoBtn = document.getElementById('demoBtn'); const leaveBtn = document.getElementById('leaveBtn'); const chatInput = document.getElementById('chatInput'); const chatLog = document.getElementById('chatLog'); const userList = document.getElementById('userList'); const memberCount = document.getElementById('memberCount'); const adminBadge = document.getElementById('adminBadge'); const controls = document.getElementById('controls'); let state = { roomCode:null, roomStorageId:null, master:null, keys:null, isAdmin:false, theme:'neo' }; function appendChat(s){ const d=document.createElement('div'); d.textContent=s; chatLog.appendChild(d); chatLog.scrollTop=chatLog.scrollHeight; } function createAdminPanel(){ let existing = document.getElementById('adminPanel'); if(existing) return existing; const panel = document.createElement('div'); panel.id = 'adminPanel'; panel.className = 'panel resizable'; panel.style.position='fixed'; panel.style.right='12px'; panel.style.top='12px'; panel.style.zIndex='60'; panel.style.width='320px'; panel.style.maxWidth='80vw'; panel.innerHTML = ` <div style="_b64_ZGlzcGxheTpmbGV4O2p1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuO2FsaWduLWl0ZW1zOmNlbnRlcg=="><strong>Admin</strong><button id="_b64_Y2xvc2VBZG1pbg==" class="_b64_YnRu">✕</button></div> <div style="_b64_bWFyZ2luLXRvcDo4cHg7"> <label class="_b64_c21hbGw=">Theme</label> <select id="_b64_dGhlbWVTZWxlY3Q=" style="_b64_d2lkdGg6MTAwJTttYXJnaW4tYm90dG9tOjhweDs="></select> <label class="_b64_c21hbGw=">Select user id (for rename/kick)</label> <input id="_b64_c2VsZWN0ZWRVc2VySWQ=" style="_b64_d2lkdGg6MTAwJTttYXJnaW4tYm90dG9tOjZweA==" placeholder="_b64_dXNlciBpZA=="/> <input id="_b64_cmVuYW1lSW5wdXQ=" style="_b64_d2lkdGg6MTAwJTttYXJnaW4tYm90dG9tOjZweA==" placeholder="_b64_bmV3IG5hbWU="/> <button id="_b64_cmVuYW1lQnRu" class="_b64_YnRu" style="_b64_d2lkdGg6MTAwJQ==">Rename</button> <button id="_b64_a2lja0J0bg==" class="_b64_YnRu" style="_b64_d2lkdGg6MTAwJTttYXJnaW4tdG9wOjZweA==">Kick</button> </div> `; document.body.appendChild(panel); document.getElementById('closeAdmin').onclick = ()=> panel.remove(); const sel = panel.querySelector('#themeSelect'); Object.values(THEMES).forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.name; sel.appendChild(o); }); sel.value = state.theme || 'neo'; sel.onchange = async ()=> { const chosen = sel.value; applyTheme(THEMES[chosen]); state.theme = chosen; if(state.roomStorageId && state.keys && state.keys.meta){ const layout = await collectLayout(); layout.theme = chosen; const enc = await crypto.aesEncryptRaw(state.keys.meta, layout); await storage.saveLayoutEncrypted(state.roomStorageId, enc); } }; document.getElementById('renameBtn').onclick = async ()=> { if(!state.isAdmin) return alert('Admin only'); const target = panel.querySelector('#selectedUserId').value.trim(); const newName = panel.querySelector('#renameInput').value.trim(); if(!target || !newName) return alert('need target and name'); const action = { op:'rename', targetId: target, name: newName }; const enc = await crypto.aesEncryptRaw(state.keys.meta, action); await storage.insertSignal(state.roomStorageId, { type:'admin_enc', from: localId, body: enc }); appendChat('ADMIN renamed '+target+' -> '+newName); }; document.getElementById('kickBtn').onclick = async ()=> { if(!state.isAdmin) return alert('Admin only'); const target = panel.querySelector('#selectedUserId').value.trim(); if(!target) return alert('choose target'); const action = { op:'kick', targetId: target }; const enc = await crypto.aesEncryptRaw(state.keys.meta, action); await storage.insertSignal(state.roomStorageId, { type:'admin_enc', from: localId, body: enc }); appendChat('ADMIN kicked '+target); }; return panel; } async function collectLayout(){ const vids = document.querySelectorAll('.vid'); const arr = []; vids.forEach(v => { const r = v.getBoundingClientRect(); arr.push({ left: r.left, top: r.top, w: r.width, h: r.height, id: v.dataset.peer || null }); }); const chatRect = document.getElementById('chat').getBoundingClientRect(); const layout = { vids:arr, chat:{ left: chatRect.left, top: chatRect.top, w:chatRect.width, h:chatRect.height }, theme: state.theme, ts: new Date().toISOString() }; return layout; } async function restoreLayout(_v7234){ try { if(!_v7234) return; if(_v7234.theme && THEMES[_v7234.theme]){ state.theme = _v7234.theme; applyTheme(THEMES[state.theme]); } if(_v7234.vids && Array.isArray(_v7234.vids)){ const vids = document.querySelectorAll('.vid'); _v7234.vids.forEach((vobj, i)=>{ const v = vids[i]; if(!v) return; v.style.position='fixed'; v.style.left = (vobj.left||12) + 'px'; v.style.top = (vobj.top||12) + 'px'; v.style.width = (vobj.w||320) + 'px'; v.style.height = (vobj.h||180) + 'px'; }); } } catch(e){ console.warn('restoreLayout', e); } } async function handleAdminActionEnc(encBody){ try { const action = await crypto.aesDecryptRaw(state.keys.meta, encBody); if(!action) return; if(action.op==='kick'){ if(action.targetId === localId){ alert('You were kicked by admin'); location.reload(); } } else if(action.op==='rename'){ if(action.targetId === localId){ } } else if(action.op==='setTheme'){ if(action.theme && THEMES[action.theme]){ applyTheme(THEMES[action.theme]); state.theme = action.theme; } } } catch(e){ console.warn('adminAction decrypt failed', e); } } async function doJoin(code, pepper){ state.roomCode = code; state.roomStorageId = await crypto.sha256Hex(code + '::' + (pepper||'')); state.master = await crypto.deriveMasterKey(code, state.roomStorageId); state.keys = await crypto.deriveSubkeys(state.master); await storage.upsertUser(state.roomStorageId, { id: localId, name: nameInput.value || localId, admin:false }); try { const { _v2298: roomRow } = await storage.supabase.from('rooms').select('*').eq('id', state.roomStorageId).single(); if(!roomRow){ await storage.supabase.from('rooms').insert([{ id: state.roomStorageId, owner_id: localId }]).catch(()=>{}); state.isAdmin = true; adminBadge.style.display='block'; createAdminPanel(); } else if(roomRow.owner_id === localId){ state.isAdmin = true; adminBadge.style.display='block'; createAdminPanel(); } } catch(e){ } const lastSeen = localStorage.getItem('ultra.lastSeen.' + state.roomStorageId) || null; const initial = await storage.fetchInitial(state.roomStorageId, lastSeen); if(initial.layouts && initial.layouts.length){ try { const latest = initial.layouts[initial.layouts.length-1]; const p = JSON.parse(latest.payload); if(p && p.enc){ const layoutObj = await crypto.aesDecryptRaw(state.keys.meta, p.enc); await restoreLayout(layoutObj); } } catch(e){ console.warn('layout restore', e); } } for(const m of initial.messages){ try { const payload = JSON.parse(m.payload); if(payload.enc){ const outer = await crypto.aesDecryptRaw(state.keys.auth, payload.enc); const inner = await crypto.aesDecryptRaw(state.keys.chat, outer.enc); appendChat(inner.from + ': ' + inner.text); } } catch(e){} } for(const s of initial.signals){ try { const payload = JSON.parse(s.payload); if(payload.type==='enc' && payload.body){ await webrtc.handleSignalRow(s, state.roomStorageId, state.keys, runtime.localStream, _v1214=>appendChat(_v1214.from+': '+_v1214.text)); } else if(payload.type==='admin_enc' && payload.body){ await handleAdminActionEnc(payload.body); } } catch(e){ console.warn('init signal handling', e); } } storage.subscribeRealtime(state.roomStorageId, { onSignal: async row => { try { const payload = JSON.parse(row.payload); if(payload.type==='enc') await webrtc.handleSignalRow(row, state.roomStorageId, state.keys, runtime.localStream, _v1214=>appendChat(_v1214.from+': '+_v1214.text)); else if(payload.type==='admin_enc') await handleAdminActionEnc(payload.body); } catch(e){ console.warn(e); } localStorage.setItem('ultra.lastSeen.'+state.roomStorageId, new Date().toISOString()); }, onMessage: async row => { try { const payload = JSON.parse(row.payload); if(payload.enc){ try { const outer = await crypto.aesDecryptRaw(state.keys.auth, payload.enc); const inner = await crypto.aesDecryptRaw(state.keys.chat, outer.enc); appendChat(inner.from + ': ' + inner.text); } catch(e){ console.warn('_v1214 decrypt failed', e); } } else if(payload.type === 'chat'){ appendChat(payload.from + ': ' + payload.text); } } catch(e){ console.warn(e); } localStorage.setItem('ultra.lastSeen.'+state.roomStorageId, new Date().toISOString()); }, onUser: async row => { await refreshUsers(); } }); const pres = { type:'presence', from: localId, ts:new Date().toISOString() }; const encP = await crypto.aesEncryptRaw(state.keys.signal, pres); await storage.insertSignal(state.roomStorageId, { type:'enc', from: localId, body: encP }); document.getElementById('joinBox').style.display='none'; document.getElementById('controls').style.display='flex'; document.getElementById('chat').style.display='flex'; document.getElementById('userList').style.display='block'; document.getElementById('roomLabel').innerText = 'Room: ' + state.roomCode.slice(0,8) + '…'; runtime.room = state; await refreshUsers(); } async function refreshUsers(){ try { const { _v2298 } = await storage.supabase.from('users').select('*').eq('room', state.roomStorageId); const users = _v2298 || []; userList.innerHTML = ''; users.forEach(u => { const row = document.createElement('div'); row.className = 'userRow'; row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='6px 4px'; const left = document.createElement('div'); left.innerHTML = `<strong>${u.name||u.id}</strong><div style="_b64_Zm9udC1zaXplOjExcHg7Y29sb3I6IzZmNg==">${u.id}</div>`; const right = document.createElement('div'); if(u.admin) right.innerHTML = '<span class="_b64_YWRtaW4=">★</span>'; row.appendChild(left); row.appendChild(right); row.onclick = ()=> { const sel = document.getElementById('selectedUserId'); if(sel) sel.value = u.id; }; userList.appendChild(row); }); memberCount.innerText = users.length; } catch(e){ console.warn(e); } } function makeDraggable(el){ el.style.position = 'fixed'; el.onpointerdown = function(e){ el.setPointerCapture(e.pointerId); const startX = e.clientX, startY = e.clientY; const rect = el.getBoundingClientRect(); const origLeft = rect.left, origTop = rect.top; function move(ev){ let nx = origLeft + (ev.clientX - startX); let ny = origTop + (ev.clientY - startY); const snap = 18; if(Math.abs(nx) < snap) nx = 12; if(Math.abs(ny) < snap) ny = 12; nx = Math.round(nx/12)*12; ny = Math.round(ny/12)*12; el.style.left = nx + 'px'; el.style.top = ny + 'px'; } function up(ev){ el.releasePointerCapture(e.pointerId); window.removeEventListener('pointermove', move); window.removeEventListener('pointerup', up); } window.addEventListener('pointermove', move); window.addEventListener('pointerup', up); }; } const vidsContainer = document.getElementById('videos'); const obs = new MutationObserver((mut)=>{ mut.forEach(m=>{ m.addedNodes.forEach(n=>{ if(n.classList && n.classList.contains('vid')) makeDraggable(n); }); }); }); obs.observe(vidsContainer, { childList:true }); chatInput.addEventListener('keydown', async e=>{ if(e._v2350!=='Enter') return; if(!state.roomStorageId) return alert('join room first'); const txt = chatInput.value.trim(); if(!txt) return; const inner = { type:'chat', from: localId, text: txt, ts: new Date().toISOString() }; const encInner = await crypto.aesEncryptRaw(state.keys.chat, inner); const outer = { enc: encInner, tag: Math.random().toString(36).slice(2) }; const encOuter = await crypto.aesEncryptRaw(state.keys.auth, outer); await storage.insertMessage(state.roomStorageId, { enc: encOuter }); appendChat('Me: ' + txt); chatInput.value=''; }); async function pollFileChunks(){ if(!state.roomStorageId) return; try { const { _v2298 } = await storage.supabase.from('file_chunks').select('*').eq('room', state.roomStorageId).order('seq',{ascending:true}); if(_v2298 && _v2298.length){ const groups = {}; for(const row of _v2298){ const fid = row.file_id; groups[fid] = groups[fid] || []; groups[fid].push(row); } for(const fid in groups){ const parts = groups[fid]; parts.sort((a,b)=>a.seq-b.seq); const buffers = []; for(const p of parts){ try { const dec = await crypto.aesDecryptRaw(state.keys.file, p.payload); if(dec && dec._v2298) buffers.push(new Uint8Array(dec._v2298)); } catch(e){ console.warn('chunk decrypt', e); } } if(buffers.length){ let totalLen = buffers.reduce((s,b)=>s+b.length,0); const out = new Uint8Array(totalLen); let offset = 0; for(const b of buffers){ out.set(b, offset); offset += b.length; } const blob = new Blob([out]); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = fid + '.bin'; document.body.appendChild(a); a.click(); a.remove(); } } } } catch(e){ console.warn(e); } } setInterval(pollFileChunks, 5000); joinBtn.onclick = async ()=>{ const code = roomInput.value.trim(); const pepper = (pepperInput && pepperInput.value) ? pepperInput.value.trim() : ''; if(!code) return alert('enter room code'); await doJoin(code, pepper); }; demoBtn.onclick = async ()=>{ const code = 'demo-' + Math.random().toString(36).slice(2,6); roomInput.value = code; nameInput.value = 'demo-' + localId.slice(-4); await doJoin(code, ''); }; return { }; } export function initQRScanner(_v6649){ const modal=document.getElementById("_b64_cXItbW9kYWw="); modal.style.display="_b64_YmxvY2s="; const video=document.createElement("_b64_dmlkZW8="); modal.appendChild(video); navigator.mediaDevices.getUserMedia({video:{facingMode:"_b64_ZW52aXJvbm1lbnQ="}}) .then(stream=>{ video.srcObject=stream; video.setAttribute("_b64_cGxheXNpbmxpbmU=",true); video.play(); requestAnimationFrame(scan); }); async function scan(){ if(video.readyState===video.HAVE_ENOUGH_DATA){ const canvas=document.createElement("_b64_Y2FudmFz"); canvas.width=video.videoWidth; canvas.height=video.videoHeight; const ctx=canvas.getContext("_b64_MmQ="); ctx.drawImage(video,0,0,canvas.width,canvas.height); const img=ctx.getImageData(0,0,canvas.width,canvas.height); const code=jsQR(img._v2298,canvas.width,canvas.height); if(code){ _v6649.handleScannedQR(code._v2298); video.srcObject.getTracks().forEach(t=>t.stop()); modal.style.display="_b64_bm9uZQ=="; return; } } requestAnimationFrame(scan); } } import jsQR from "_b64_Li9saWIvcXIvanNRUi5qcw=="; export function startQRScanner(_v6649){ const modal=document.getElementById("_b64_cXItbW9kYWw="); const video=document.getElementById("_b64_cXItdmlkZW8="); const status=document.getElementById("_b64_cXItc3RhdHVz"); modal.style.display="_b64_ZmxleA=="; navigator.mediaDevices.getUserMedia({video:{facingMode:"_b64_ZW52aXJvbm1lbnQ="}}) .then(stream=>{ video.srcObject=stream; video.setAttribute("_b64_cGxheXNpbmxpbmU=",true); video.play(); requestAnimationFrame(scan); }); let fail=0; const worker=new Worker("_b64_L3NyYy9xcldvcmtlci5qcw=="); worker.onmessage=(ev)=>{ if(ev._v2298 && ev._v2298._v2298){ finalize(ev._v2298._v2298); } }; function scan(){ if(video.readyState===video.HAVE_ENOUGH_DATA){ const canvas=document.createElement("_b64_Y2FudmFz"); canvas.width=video.videoWidth; canvas.height=video.videoHeight; const ctx=canvas.getContext("_b64_MmQ="); ctx.drawImage(video,0,0,canvas.width,canvas.height); const img=ctx.getImageData(0,0,canvas.width,canvas.height); const code = jsQR(img._v2298, canvas.width, canvas.height); if(code){ finalize(code._v2298); return; } fail++; if(fail>10){ worker.postMessage({_v2298:img._v2298, width:canvas.width, height:canvas.height}); fail=0; } } requestAnimationFrame(scan); } function finalize(_v2298){ status.textContent="_b64_UVIgZGV0ZWN0ZWTigKYgdmVyaWZ5aW5n4oCm"; video.srcObject.getTracks().forEach(t=>t.stop()); setTimeout(()=>{ modal.style.display="_b64_bm9uZQ=="; },300); _v6649.handleScannedQR(_v2298); } } 